<html>
<body>

<br />

Video<br />
<video id="me" width="40" height="30" autoplay muted></video> <br />
<video id="video1" width="160" height="120" autoplay muted></video> <br />

<input id="room"></input>
<button class="createSessionButton" onclick="window.createSession()"> Join to room </button>

<br />

Logs<br />
<div id="logs"></div>



</body>
<script>
    /* eslint-env browser */
    var log = msg => {
        document.getElementById('logs').innerHTML += msg + '<br>'
    }

    function makeid(length) {
        let result = '';
        const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
        const charactersLength = characters.length;
        let counter = 0;
        while (counter < length) {
            result += characters.charAt(Math.floor(Math.random() * charactersLength));
            counter += 1;
        }
        return result;
    }

    const session_id = makeid(5);


    const ws = new WebSocket("ws://localhost:8080/ws?session_id=" + session_id)
    let pc


    ws.addEventListener("message", (event) => {
        // console.log(event.data)
        // if (event.data == "renegotiation") {
        //     renegotiation();
        // }

        const d = JSON.parse(event.data)
        if (d.type == "offer") {
            console.log(d)
            pc.setRemoteDescription(d);
            pc.createAnswer().then(sdp => {
                console.log(sdp)
                pc.setLocalDescription(sdp)
                ws.send(JSON.stringify(sdp))
            })
        }
    })

    let candidates = [];
    let renegotiation = function () {
        // candidates = [];

        pc.createOffer()
            .then(offer => {
                pc.setLocalDescription(offer)
                fetch("http://localhost:8080/sdp", {method: "post",
                    body: JSON.stringify({offer, session_id, room_id: document.querySelector("#room").value}),
                    headers: {
                        "Content-Type": "application/json"
                    }})
                    .then(res => res.json())
                    .then(resp => {
                        console.log(resp)
                        //session_id = resp.session_id
                        pc.setRemoteDescription(resp.answer)

                        setTimeout(() => {
                            console.log(candidates)



                            fetch("http://localhost:8080/candidates", {method: "post",
                                body: JSON.stringify({candidates, session_id}),
                                headers: {
                                    "Content-Type": "application/json"
                                }})
                                // .then(res => res.json())
                                .then(resp => {

                                })



                        }, 2000)
                    })
            })
            .catch(log)
    }

    window.createSession = () => {
        pc = new RTCPeerConnection({
            iceServers: [
                {
                    urls: ['stun:stun.l.google.com:19302', 'stun:stun.l.google.com:5349', 'stun:stun1.l.google.com:3478']
                }
            ]
        })

        pc.onnegotiationneeded = e => {
            console.log('negotiationneeded', e)
            renegotiation();
        }


        pc.oniceconnectionstatechange = e => log(pc.iceConnectionState)

        pc.onicecandidate = event => {
            //console.log(event);
            if (event.candidate === null) {
                console.log(event.candidate)
                // push candidates
            } else {
                candidates.push(event.candidate)
            }
        }


        pc.ontrack = function (event) {
            console.log("ontrack", event);
            var el = document.getElementById('video1')
            el.srcObject = event.streams[0]
            el.autoplay = true
            el.controls = true
        }
        pc.addTransceiver('video')

        navigator.mediaDevices.getUserMedia({ video: true, audio: false })
            .then(stream => {
                stream.getTracks().forEach(track => pc.addTrack(track, stream));
                document.getElementById('me').srcObject = stream

                // renegotiation()


            }).catch(log)
    }

</script>
</html>